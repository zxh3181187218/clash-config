# Clash Meta Strict Anti-Leak Configuration
# 特殊设计：全量代理模式 (国内走成都代理，国外走德国代理)

port: 7890
socks-port: 7891
mixed-port: 7892
allow-lan: true
mode: rule
log-level: info
ipv6: false
external-controller: 127.0.0.1:9090

# --- DNS 核心配置 (防泄漏关键) ---
dns:
  enable: true
  listen: 0.0.0.0:1053
  ipv6: false
  # 强制 Fake-IP，这是防泄漏的最强手段
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  
  # 必须开启，尊重规则中的 DNS 映射
  respect-rules: true 

  # 1. 默认 DNS (解析国外网站用) - 强制使用 Google DoH
  nameserver:
    - https://8.8.8.8/dns-query
    - https://1.1.1.1/dns-query

  # 2. 分流 DNS (解析国内网站用) - 强制使用阿里/腾讯 DoH
  nameserver-policy:
    "geosite:cn,private":
      - https://223.5.5.5/dns-query
      - https://1.12.12.12/dns-query

# --- 嗅探配置 ---
sniffer:
  enable: true
  parse-pure-ip: true
  sniff:
    tls:
      ports: [443, 8443]
    http:
      ports: [80, 8080-8880]
      override-destination: true

# --- 代理节点 ---
proxies:
  - name: "德国🇩🇪免流"
    type: vmess
    server: 47.108.130.60
    port: 15821
    uuid: 4b64ce4d-72d5-463b-acba-90773c064ab8
    alterId: 0
    cipher: auto
    network: ws
    ws-opts:
      path: "/"
      headers:
        Host: pull.free.video.10010.com

  - name: "成都🇨🇳免流"
    type: vmess
    server: 47.108.130.60
    port: 49084
    uuid: 4b64ce4d-72d5-463b-acba-90773c064ab8
    alterId: 0
    cipher: auto
    network: ws
    ws-opts:
      path: "/"
      headers:
        Host: pull.free.video.10010.com

# --- 策略组 ---
proxy-groups:
  # 国外流量 -> 德国节点
  - name: "🌍 国外流量"
    type: select
    proxies:
      - "德国🇩🇪免流"
      - "成都🇨🇳免流"

  # 国内流量 -> 成都节点 (注意：这里不再包含 DIRECT，强制走代理)
  - name: "🇨🇳 国内流量"
    type: select
    proxies:
      - "成都🇨🇳免流"
      - "德国🇩🇪免流"

  # 兜底
  - name: "🐟 漏网之鱼"
    type: select
    proxies:
      - "🌍 国外流量"
      - "🇨🇳 国内流量"

# --- 规则 (防泄漏逻辑闭环) ---
rules:
  # [关键步骤1]：将 Google DNS 的请求流量，强制导入“国外流量”组(走德国节点)
  # 这样你的 ISP 只能看到你连了代理，看不到你在请求 Google DNS
  - IP-CIDR,8.8.8.8/32,🌍 国外流量
  - IP-CIDR,1.1.1.1/32,🌍 国外流量
  - DOMAIN,dns.google,🌍 国外流量
  - DOMAIN,cloudflare-dns.com,🌍 国外流量

  # [关键步骤2]：将 阿里/腾讯 DNS 的请求流量，强制导入“国内流量”组(走成都节点)
  # 确保即使解析国内域名，DNS 请求也是通过成都节点发出的
  - IP-CIDR,223.5.5.5/32,🇨🇳 国内流量
  - IP-CIDR,223.6.6.6/32,🇨🇳 国内流量
  - IP-CIDR,1.12.12.12/32,🇨🇳 国内流量
  - DOMAIN,dns.alidns.com,🇨🇳 国内流量
  - DOMAIN,doh.pub,🇨🇳 国内流量

  # [常规分流]
  - GEOSITE,cn,🇨🇳 国内流量
  - GEOSITE,private,🇨🇳 国内流量
  - GEOIP,cn,🇨🇳 国内流量
  
  # [默认]
  - MATCH,🌍 国外流量
