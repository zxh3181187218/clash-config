# Clash Meta (Mihomo) Ultimate Anti-Leak Config
# 专治各种 DNS 泄漏疑难杂症

port: 7890
socks-port: 7891
mixed-port: 7892
allow-lan: true
mode: rule
log-level: info
ipv6: false
external-controller: 127.0.0.1:9090

# --- DNS 配置 (绝对防漏版) ---
dns:
  enable: true
  listen: 0.0.0.0:1053
  ipv6: false
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  
  # 必须开启，确保 DNS 遵循路由规则
  respect-rules: true 

  # 【核心修改】：直接使用 IP 地址的 DoH，不给系统本地解析的机会
  # 默认 DNS (给国外网站用)：Google DoH (IP形式)
  nameserver:
    - https://8.8.8.8/dns-query
    - https://1.1.1.1/dns-query

  # 分流 DNS (给国内网站用)：阿里 DoH (IP形式)
  nameserver-policy:
    "geosite:cn,private":
      - https://223.5.5.5/dns-query
      - https://223.6.6.6/dns-query

  # 只有当 nameserver 全部失效时才使用 (留空或填代理 DNS，绝不填本地 DNS)
  fallback: []

# --- 嗅探配置 ---
sniffer:
  enable: true
  parse-pure-ip: true
  sniff:
    tls:
      ports: [443, 8443]
    http:
      ports: [80, 8080-8880]
      override-destination: true

# --- 代理节点 ---
proxies:
  - name: "德国🇩🇪免流"
    type: vmess
    server: 47.108.130.60
    port: 15821
    uuid: 4b64ce4d-72d5-463b-acba-90773c064ab8
    alterId: 0
    cipher: auto
    network: ws
    ws-opts:
      path: "/"
      headers:
        Host: pull.free.video.10010.com

  - name: "成都🇨🇳免流"
    type: vmess
    server: 47.108.130.60
    port: 49084
    uuid: 4b64ce4d-72d5-463b-acba-90773c064ab8
    alterId: 0
    cipher: auto
    network: ws
    ws-opts:
      path: "/"
      headers:
        Host: pull.free.video.10010.com

# --- 策略组 ---
proxy-groups:
  # 国外流量 -> 德国
  - name: "🌍 国外流量"
    type: select
    proxies:
      - "德国🇩🇪免流"
      - "成都🇨🇳免流"

  # 国内流量 -> 成都 (强制走代理，不直连，防止通过直连漏 DNS)
  - name: "🇨🇳 国内流量"
    type: select
    proxies:
      - "成都🇨🇳免流"
      - "德国🇩🇪免流"

  # 兜底
  - name: "🐟 漏网之鱼"
    type: select
    proxies:
      - "🌍 国外流量"
      - "🇨🇳 国内流量"

# --- 规则 (逻辑闭环) ---
rules:
  # 【防泄漏核心规则】：必须放在最前面！
  # 含义：只要是去访问 8.8.8.8 (Google DNS) 的流量，必须走德国代理
  # 含义：只要是去访问 223.5.5.5 (阿里 DNS) 的流量，必须走成都代理
  # 这样你的 ISP 根本不知道你在做 DNS 查询，只看到你连了代理 IP
  
  - IP-CIDR,8.8.8.8/32,🌍 国外流量
  - IP-CIDR,1.1.1.1/32,🌍 国外流量
  - IP-CIDR,223.5.5.5/32,🇨🇳 国内流量
  - IP-CIDR,223.6.6.6/32,🇨🇳 国内流量

  # 常规分流
  - GEOSITE,cn,🇨🇳 国内流量
  - GEOSITE,private,🇨🇳 国内流量
  - GEOIP,cn,🇨🇳 国内流量
  
  # 默认
  - MATCH,🌍 国外流量
