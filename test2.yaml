# ---------------------------------------------------
# 基础设置
# ---------------------------------------------------
port: 7890
socks-port: 7891
allow-lan: true
mode: rule
log-level: info
# 【核心】强制关闭 IPv6，防止抖音绕过代理暴露真实位置
ipv6: false
external-controller: '127.0.0.1:9090'

# ---------------------------------------------------
# TUN 模式 (接管系统所有流量)
# ---------------------------------------------------
tun:
  enable: true
  stack: system           # Android/Windows 选 system
  auto-route: true        # 自动添加路由
  auto-detect-interface: true
  # 开启严格路由，防止流量泄露
  strict-route: true
  dns-hijack:
    - any:53

# ---------------------------------------------------
# 嗅探器 (让规则对纯 IP 流量也能生效)
# ---------------------------------------------------
sniffer:
  enable: true
  parse-pure-ip: true
  sniff:
    TLS:
      ports: [443, 8443]
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true

# ---------------------------------------------------
# DNS 设置 (防泄露 + 强制远端解析)
# ---------------------------------------------------
dns:
  enable: true
  listen: 0.0.0.0:1053
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  fake-ip-filter:
    - "*.lan"
    - "*.localhost"
    - "stun.*"
    - "msftconnecttest.com"
    - "msftncsi.com"
  
  # 1. 默认 DNS：只留纯 IP，仅用于引导启动
  default-nameserver:
    - 1.1.1.1
    - 8.8.8.8
  
  # 2. 核心 DNS：全部使用加密 DoH，防止运营商窥探
  nameserver:
    - https://1.1.1.1/dns-query
    - https://8.8.8.8/dns-query
  
  # 3. 策略 DNS：为了保证抖音 IP 是成都，强制抖音的域名解析也走成都节点
  # 格式：域名: DNS服务器#策略组名称
  nameserver-policy:
    "geosite:cn": https://223.5.5.5/dns-query#成都
    "*.douyin.com": https://223.5.5.5/dns-query#成都
    "*.amemv.com": https://223.5.5.5/dns-query#成都
    "*.snssdk.com": https://223.5.5.5/dns-query#成都

  # 4. 代理 DNS：解析节点域名用的，必须填，否则报错
  proxy-server-nameserver:
    - https://1.1.1.1/dns-query
    - https://8.8.8.8/dns-query
    
  # 【核心】移除 fallback，禁止回退到本地运营商 DNS，彻底杜绝泄露
  # fallback: [] 

  respect-rules: true

# ---------------------------------------------------
# 代理节点
# ---------------------------------------------------
proxies:
  - name: "美国"
    type: vless
    server: 47.108.229.151
    port: 40539
    uuid: c8ccc5cd-fb5d-42ed-987f-36dec6152818
    cipher: auto
    network: ws
    tls: false
    # UDP 设置为 true 以支持其他应用，但我们在规则里专门屏蔽抖音的 UDP
    udp: true 
    ws-opts:
      path: "/"
      headers:
        Host: pull.free.video.10010.com

  - name: "成都"
    type: vless
    server: 47.108.229.151
    port: 46513
    uuid: c8ccc5cd-fb5d-42ed-987f-36dec6152818
    alterId: 0
    cipher: auto
    network: ws
    tls: false
    udp: true
    ws-opts:
      path: "/"
      headers:
        Host: pull.free.video.10010.com

# ---------------------------------------------------
# 代理组
# ---------------------------------------------------
proxy-groups:
  # 专门为抖音建立的组
  - name: "抖音限定"
    type: select
    proxies:
      - "成都"

  - name: "国外流量"
    type: select
    proxies:
      - "美国"

  - name: "国内流量"
    type: select
    proxies:
      - "成都"
      - "DIRECT" 

# ---------------------------------------------------
# 分流规则
# ---------------------------------------------------
rules:
  # 1. 必须放在第一条：防止 IPv6 泄露
  - IP-CIDR6,::/0,REJECT,no-resolve
  
  # 2. 去广告
  - GEOSITE,category-ads-all,REJECT
  
  # ---------------------------------------------------
  # 【关键修改】解决免流跳点 (跑流量) 问题
  # 阻断抖音 UDP，强制走 TCP (Host 混淆对 TCP 最有效)
  # ---------------------------------------------------
  - AND,((NETWORK,UDP),(DOMAIN-SUFFIX,douyin.com)),REJECT
  - AND,((NETWORK,UDP),(DOMAIN-SUFFIX,amemv.com)),REJECT
  - AND,((NETWORK,UDP),(DOMAIN-SUFFIX,snssdk.com)),REJECT
  - AND,((NETWORK,UDP),(DOMAIN-KEYWORD,core-c-lq)),REJECT
  
  # 3. 解决 IP 归属地问题：强制抖音走成都节点
  - DOMAIN-SUFFIX,douyin.com,抖音限定
  - DOMAIN-SUFFIX,amemv.com,抖音限定
  - DOMAIN-SUFFIX,snssdk.com,抖音限定
  - DOMAIN-KEYWORD,core-c-lq,抖音限定
  
  # 4. 常规规则
  - GEOSITE,google-play,国外流量
  - GEOSITE,google,国外流量
  
  # 5. 国内流量全走成都 (你可以改回 DIRECT，但为了防止 DNS 泄露建议走代理)
  - GEOSITE,CN,国内流量
  - GEOIP,CN,国内流量
  
  # 6. 兜底
  - MATCH,国外流量
