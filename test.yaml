port: 7890
socks-port: 7891
allow-lan: true
mode: rule
log-level: info
external-controller: :9090

# --- DNS 设置 (严格锁定 CF/Google) ---
dns:
  enable: true
  listen: 0.0.0.0:53
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  nameserver:
    - 1.1.1.1
    - 1.0.0.1
    - 8.8.8.8
    - 8.8.4.4
    - https://1.1.1.1/dns-query
    - https://8.8.8.8/dns-query
  fallback: []
  respect-rules: true

proxies:
  # --- 节点 1: 成都入口 ---
  - name: "1_成都中转"
    type: vmess
    server: 47.108.130.60
    port: 25477
    uuid: 8f800fe3-5af8-4021-cc74-fc159ca640a9
    alterId: 0
    cipher: auto
    network: ws
    ws-opts:
      path: "/"
      headers:
        Host: pull.free.video.10010.com

  # --- 节点 2: 美国出口 ---
  - name: "2_美国落地"
    type: vless
    server: ipv6.zxh425.dpdns.org
    port: 443
    uuid: 3a7d914d-86d9-4cec-8e65-b08f5c0b98ab
    network: tcp
    tls: true
    udp: true
    flow: xtls-rprx-vision
    servername: gateway.icloud.com
    client-fingerprint: chrome
    reality-opts:
      public-key: IXNtZnkoBPz2Yz-o1Jia8gQLeCj4mh-cszPFQys_OH4
      short-id: f71dda44e6f4f3b7

proxy-groups:
  # --- 策略组 1: 国外流量 (链式: 本地->成都->美国) ---
  - name: "✈️ 国外流量"
    type: relay
    proxies:
      - "1_成都中转"
      - "2_美国落地"

  # --- 策略组 2: 国内流量 (中转: 本地->成都) ---
  - name: "🏠 国内流量"
    type: select
    proxies:
      - "1_成都中转"

rules:
  # --- 修复后的 WebRTC 阻断规则 ---
  # 移除 "/udp" 后缀，直接阻断该端口的所有协议
  - DST-PORT,3478,REJECT
  
  # --- DNS 引导规则 (强制走成都) ---
  - IP-CIDR,1.1.1.1/32,🏠 国内流量
  - IP-CIDR,1.0.0.1/32,🏠 国内流量
  - IP-CIDR,8.8.8.8/32,🏠 国内流量
  - IP-CIDR,8.8.4.4/32,🏠 国内流量

  # --- 分流逻辑 ---
  - GEOSITE,CN,🏠 国内流量
  - GEOIP,CN,🏠 国内流量
  
  # --- 剩余流量走链式 ---
  - MATCH,✈️ 国外流量
  
